{% extends "base.html" %}
{% block title %}Asignar{% endblock %}

{% block content %}
{% set local = partido.equipo_local or (ATLETICO_TEAM_NAME if partido.localia else partido.rival) %}
{% set visitante = partido.equipo_visitante or (partido.rival if partido.localia else ATLETICO_TEAM_NAME) %}
{% set theme = competition_theme(partido.competicion, partido.localia == 1) %}
{% set logo_local = partido.logo_local %}
{% set logo_visitante = partido.logo_visitante %}

<div class="card shadow-soft mb-4">
    <div class="card-body d-flex flex-column gap-3 card-header-accent">
        <div class="d-flex flex-row justify-content-between align-items-start gap-3 flex-wrap">
            <div>
                <p class="mb-1">{{ partido.competicion or 'Pendiente' }}</p>
                <div class="match-card__teams">
                    <strong class="d-flex align-items-center gap-2">
                        {% if logo_local %}
                            <img src="{{ logo_local }}" alt="{{ local }}" class="team-badge">
                        {% endif %}
                        {{ local }}
                    </strong>
                    <span class="vs-text">vs</span>
                    <strong class="d-flex align-items-center gap-2">
                        {% if logo_visitante %}
                            <img src="{{ logo_visitante }}" alt="{{ visitante }}" class="team-badge">
                        {% endif %}
                        {{ visitante }}
                    </strong>
                </div>
                <p class="mb-1"><strong>Fecha:</strong> {{ partido.fecha | human_datetime }}</p>
                {% if partido.estadio %}
                    <p class="mb-0"><strong>Estadio:</strong> {{ partido.estadio }}</p>
                {% endif %}
            </div>
            <div class="match-card__competition">
                <img src="{{ url_for('static', filename=theme.icon) }}" alt="{{ theme.label }}">
            </div>
        </div>
        <div class="subheader-highlight">
            <strong>Asignando:</strong>
            {% if modo_multiple %}
                {% if seleccion_abonos|length == 0 %}
                    {{ seleccion_parkings|length }} parking{{ 's' if seleccion_parkings|length != 1 else '' }}
                {% elif seleccion_parkings|length == 0 %}
                     {{ seleccion_abonos|length }} abono{{ 's' if seleccion_abonos|length != 1 else '' }}
                {% elif seleccion_abonos|length == 1 and seleccion_parkings|length == 1 %}
                    {{ seleccion_abonos|length }} abono · {{ seleccion_parkings|length }} parking
                {% elif seleccion_abonos|length == 1 %}
                    {{ seleccion_abonos|length }} abono · {{ seleccion_parkings|length }} parkings
                {% elif seleccion_parkings|length == 1 %}
                    {{ seleccion_abonos|length }} abonos · {{ seleccion_parkings|length }} parking
                {% else %}
                    {{ seleccion_abonos|length }} abonos · {{ seleccion_parkings|length }} parkings
                {% endif %}
            {% else %}
                {% if tipo == 'abono' %}
                    {{ format_abono(recurso) }}
                {% else %}
                    {{ format_parking(recurso) }}
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<div class="card shadow-soft">
    <div class="card-body">
        <h2 class="texto-guapo">Selecciona un cliente</h2>
        <div class="new-client-row">
            <div colspan="2">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="collapse"
                        data-bs-target="#nuevoClienteForm" aria-expanded="false" aria-controls="nuevoClienteForm">
                        + Nuevo cliente
                    </button>
                    <div class="collapse collapse-no-anim" id="nuevoClienteForm">
                        <form method="post" class="row g-2 align-items-end mt-2">
                            {% if modo_multiple %}
                                {% for abono_id in seleccion_abonos %}
                                    <input type="hidden" name="abono_ids" value="{{ abono_id }}">
                                {% endfor %}
                                {% for parking_id in seleccion_parkings %}
                                    <input type="hidden" name="parking_ids" value="{{ parking_id }}">
                                {% endfor %}
                            {% endif %}
                            <input type="hidden" name="crear_cliente" value="1">
                            <div class="col-md-8">
                                <label class="form-label small mb-1 fw-bold" for="nuevo_nombre">Nombre</label>
                                <input type="text" name="nuevo_nombre" id="nuevo_nombre" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" type="submit">Guardar cliente</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% if clientes %}
            <div class="mb-3">
                <input
                    type="search"
                    class="form-control client-search-input"
                    placeholder="Buscar cliente..."
                    data-client-search
                    autocomplete="off"
                >
            </div>
            <div class="table-responsive client-select-table-scroll">
                <table class="table align-middle">
                    <tbody>
                    {% for cliente in clientes %}
                        <tr data-client-row data-client-name="{{ cliente.nombre|lower }}">
                            <td>{{ cliente.nombre }}</td>
                            <td class="text-end">
                                <form method="post">
                                    {% if modo_multiple %}
                                        {% for abono_id in seleccion_abonos %}
                                            <input type="hidden" name="abono_ids" value="{{ abono_id }}">
                                        {% endfor %}
                                        {% for parking_id in seleccion_parkings %}
                                            <input type="hidden" name="parking_ids" value="{{ parking_id }}">
                                        {% endfor %}
                                    {% endif %}
                                    <input type="hidden" name="cliente_id" value="{{ cliente.id }}">
                                    <button class="btn btn-primary btn-sm" type="submit">Asignar</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted mb-0">
                Aún no hay clientes registrados. Agrega uno para poder asignar.
            </p>
            <div class="mt-3">
                <form method="post" class="row g-2 align-items-end">
                    {% if modo_multiple %}
                        {% for abono_id in seleccion_abonos %}
                            <input type="hidden" name="abono_ids" value="{{ abono_id }}">
                        {% endfor %}
                        {% for parking_id in seleccion_parkings %}
                            <input type="hidden" name="parking_ids" value="{{ parking_id }}">
                        {% endfor %}
                    {% endif %}
                    <input type="hidden" name="crear_cliente" value="1">
                    <div class="col-md-8">
                        <label class="form-label small mb-1" for="nuevo_nombre_empty"></label>
                        <input type="text" name="nuevo_nombre" id="nuevo_nombre_empty" placeholder="Nombre del nuevo cliente" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" type="submit">Guardar cliente</button>
                    </div>
                </form>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}
